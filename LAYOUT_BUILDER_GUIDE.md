# Layout Builder Tool - دليل أداة ترتيب الصناديق

## نظرة عامة (Overview)

أداة ترتيب الصناديق (Layout Builder) هي أداة متطورة تتيح لأصحاب المتاجر تنظيم وترتيب الصناديق الثابتة على الصفحة الرئيسية لمتجرهم. تم تصميم هذه الأداة لإدارة الصناديق التي تحتوي فقط على صور وعناوين وروابط (بدون محتوى ديناميكي أو حلقات).

The Layout Builder is an advanced tool that allows store owners to organize and arrange static boxes on their homepage. This tool is designed to manage boxes that contain only images, titles, and links (no dynamic content or loops).

---

## الميزات الرئيسية (Key Features)

### 1. الكشف التلقائي عن الصناديق الثابتة
- يكتشف النظام تلقائيًا جميع الصناديق الثابتة من قسم "الصفحة الرئيسية والبطل"
- يحلل كل صندوق ويحدد نوع تخطيطه بناءً على موقعه
- يدعم ما يصل إلى 10 صناديق مختلفة بأحجام وتخطيطات متنوعة

### 2. السحب والإفلات لإعادة الترتيب
- واجهة سهلة الاستخدام للسحب والإفلات
- يتم حفظ الترتيب الجديد تلقائيًا في قاعدة البيانات
- التغييرات تنعكس فورًا على الصفحة الرئيسية

### 3. محرر جانبي للتعديلات السريعة
- تعديل محتوى أي صندوق بنقرة واحدة
- معاينة مباشرة للصورة
- تحرير العنوان، العنوان الفرعي، نص الزر، ورابط الزر
- دعم الحقول الإضافية (مثل النسب المئوية للخصم، النصوص الإضافية، إلخ)

### 4. معاينة مرئية
- عرض مصغر لكل صندوق مع معلوماته
- إشارات مرئية لترتيب الصناديق (#1, #2, إلخ)
- تمييز الصندوق المحدد للتعديل

---

## كيفية الوصول إلى الأداة

1. قم بتسجيل الدخول إلى لوحة التحكم الإدارية
2. انتقل إلى: **الثيمات → تخصيص الثيم النشط**
3. اختر تبويب **"أداة ترتيب الصناديق (Layout Builder)"**

---

## البنية التقنية (Technical Structure)

### قاعدة البيانات
يتم تخزين بيانات الصناديق في جدول `themes_data` في عمود `hero_data`:

```json
{
  "slides": [
    {
      "id": "box-0",
      "title": "عنوان الصندوق",
      "subtitle": "العنوان الفرعي",
      "button_text": "تسوق الآن",
      "button_link": "/products",
      "image": "themes/torganic/hero/image.jpg",
      "order": 0
    }
  ]
}
```

### أنواع التخطيطات المدعومة

| الموضع | الاسم | الحجم | فئة Bootstrap |
|-------|------|-------|--------------|
| 0 | Hero Principal | كبير | col-xl-8 |
| 1 | Banner Superior Derecho | متوسط | col-md-6 col-xl-12 |
| 2 | Banner Inferior Derecho | متوسط | col-md-6 col-xl-12 |
| 3 | Banner Lateral 1 | صغير | col-xl-3 col-md-6 |
| 4 | Banner Central Grande | كبير | col-xl-6 col-lg-12 |
| 5 | Banner Lateral 2 | صغير | col-xl-3 col-md-6 |
| 6 | Banner Secundario 1 | متوسط | col-lg-6 |
| 7 | Banner Secundario 2 | متوسط | col-lg-6 |
| 8 | Banner Largo Inferior | كبير جدًا | col-12 |

---

## استخدام الأداة (How to Use)

### 1. إضافة صناديق جديدة
1. انتقل إلى تبويب "الصفحة الرئيسية والبطل"
2. أضف صورة جديدة مع البيانات المطلوبة:
   - العنوان (Title)
   - العنوان الفرعي (Subtitle)
   - نص الزر (Button Text)
   - رابط الزر (Button Link)
   - الصورة (Image)
3. احفظ التغييرات
4. سيظهر الصندوق الجديد تلقائيًا في أداة ترتيب الصناديق

### 2. إعادة ترتيب الصناديق
1. افتح تبويب "أداة ترتيب الصناديق"
2. اسحب الصندوق من أيقونة السحب (⋮⋮)
3. أفلته في المكان الجديد
4. يتم الحفظ تلقائيًا

### 3. تعديل صندوق
1. انقر على زر "تعديل" (أيقونة القلم) بجانب الصندوق
2. سيفتح المحرر الجانبي على اليمين
3. عدّل الحقول المطلوبة:
   - العنوان
   - العنوان الفرعي
   - نص الزر
   - رابط الزر
   - الحقول الإضافية (إن وجدت)
4. اضغط "حفظ التغييرات"

### 4. الحقول الإضافية
بعض الصناديق تدعم حقولاً إضافية مثل:
- `discount_text`: نص الخصم (مثل: "خصم حتى")
- `discount_amount`: مقدار الخصم (مثل: "20%")
- `description`: وصف إضافي
- `badge_text`: نص الشارة
- `badge_amount`: قيمة الشارة
- `badge_label`: تسمية الشارة

---

## التكامل مع الثيمات (Theme Integration)

### في ملفات Blade

```php
@php
    // الحصول على بيانات الثيم
    $themeData = \App\Models\ThemeData::getByStoreAndTheme($storeId, $themeName);
    
    // استخراج الصناديق
    $heroSlides = $themeData['hero_data']['slides'] ?? [];
    
    // الوصول إلى صندوق معين
    $heroSlide1 = $heroSlides[0] ?? null;
    $heroSlide2 = $heroSlides[1] ?? null;
@endphp

<!-- استخدام بيانات الصندوق -->
@if($heroSlide1)
    <div class="banner-box">
        @if(isset($heroSlide1['image']))
            <img src="{{ asset('storage/' . $heroSlide1['image']) }}" 
                 alt="{{ $heroSlide1['title'] }}">
        @endif
        
        <h2>{{ $heroSlide1['title'] }}</h2>
        <p>{{ $heroSlide1['subtitle'] }}</p>
        
        @if($heroSlide1['button_text'])
            <a href="{{ $heroSlide1['button_link'] }}" class="btn">
                {{ $heroSlide1['button_text'] }}
            </a>
        @endif
    </div>
@endif
```

---

## API Methods (طرق البرمجة)

### Livewire Component Methods

#### `loadLayoutBoxes()`
يقوم بتحميل جميع الصناديق من `hero_slides` وتحويلها إلى تنسيق قابل للإدارة.

#### `updateBoxOrder($orderedIds)`
يقوم بتحديث ترتيب الصناديق بناءً على المصفوفة الجديدة للمعرفات.

**Parameters:**
- `$orderedIds` (array): مصفوفة من معرفات الصناديق بالترتيب الجديد

**Example:**
```php
$this->updateBoxOrder(['box-2', 'box-0', 'box-1']);
```

#### `selectBox($boxId)`
يقوم بتحديد صندوق للتعديل في المحرر الجانبي.

**Parameters:**
- `$boxId` (string): معرف الصندوق

#### `updateSelectedBox()`
يقوم بحفظ التغييرات على الصندوق المحدد.

#### `getThemeLayoutConfig()`
يعيد مصفوفة بتكوينات التخطيط لجميع مواضع الصناديق.

**Returns:**
```php
[
    ['position' => 0, 'name' => 'Hero Principal', 'size' => 'large', 'col' => 'col-xl-8'],
    // ... المزيد
]
```

---

## المتطلبات التقنية (Technical Requirements)

### المكتبات المستخدمة
- **Sortable.js** v1.15.0: للسحب والإفلات
- **Livewire** v3.x: للتفاعلية
- **Alpine.js** v3.x: لإدارة الحالة المحلية
- **Tailwind CSS**: للتنسيق

### المتصفحات المدعومة
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

---

## استكشاف الأخطاء (Troubleshooting)

### المشكلة: السحب والإفلات لا يعمل
**الحل:**
1. تأكد من تحميل مكتبة Sortable.js بشكل صحيح
2. تحقق من وجود أخطاء في Console المتصفح
3. تأكد من تفعيل JavaScript في المتصفح
4. حاول إعادة تحميل الصفحة

### المشكلة: الصناديق لا تظهر
**الحل:**
1. تأكد من إضافة صور في قسم "الصفحة الرئيسية والبطل"
2. تحقق من أن `hero_data` يحتوي على بيانات في قاعدة البيانات
3. تأكد من صلاحيات الوصول للملفات المرفوعة

### المشكلة: التغييرات لا تُحفظ
**الحل:**
1. تحقق من اتصال الإنترنت
2. تأكد من عدم وجود أخطاء في لوحة المطور
3. تحقق من صلاحيات الكتابة على قاعدة البيانات
4. راجع ملفات logs في Laravel

---

## الأمان (Security)

- جميع التحديثات تتم عبر Livewire مع حماية CSRF
- التحقق من الصلاحيات يتم على مستوى الخادم
- تصفية جميع المدخلات لمنع XSS
- التحقق من أنواع الملفات المرفوعة

---

## الأداء (Performance)

- تحميل كسول للصور الكبيرة
- تحديثات فورية بدون إعادة تحميل الصفحة
- تخزين مؤقت للبيانات على مستوى المتصفح
- استعلامات محسّنة لقاعدة البيانات

---

## الدعم والمساعدة

للحصول على المساعدة أو الإبلاغ عن مشاكل:
1. راجع هذا الدليل أولاً
2. تحقق من ملفات logs في `storage/logs/laravel.log`
3. تواصل مع فريق التطوير

---

## التحديثات المستقبلية

خطط التطوير المستقبلية:
- [ ] دعم السحب والإفلات بين تخطيطات مختلفة
- [ ] معاينة مباشرة للتغييرات
- [ ] استيراد/تصدير تكوينات التخطيط
- [ ] قوالب جاهزة للتخطيطات
- [ ] دعم أنواع محتوى إضافية

---

**آخر تحديث:** أكتوبر 2025  
**الإصدار:** 1.0.0

